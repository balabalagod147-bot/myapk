# =========================================================================
#             优化后的 Buildozer Android APK 工作流
# =========================================================================
name: Buildozer Android APK

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 步骤 1: 检出你的项目代码
    - name: Checkout
      uses: actions/checkout@v4

    # 步骤 2: 设置 Java (JDK)，这是 Android 构建所必需的
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 步骤 3: 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 步骤 4: 安装 Android SDK 和相关组件
    # 这个 Action 会自动处理下载、解压、接受许可和设置环境变量 (ANDROID_HOME)
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    # 步骤 5: 安装 Buildozer 及其依赖
    - name: Install Buildozer and dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade buildozer "cython<3.0"

    # 步骤 6: 使用 Buildozer 构建 APK
    # 无需再手动设置复杂的 PATH 或后台脚本
    - name: Build with Buildozer
      run: |
        buildozer -v android debug

    # 步骤 7: 上传构建好的 APK 文件作为产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-package
        # 路径通常在 bin/ 目录下，如果你的 buildozer.spec 文件有修改，请相应调整
        path: bin/*.apk
