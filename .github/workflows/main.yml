# =========================================================================
#             最终优化版 - Buildozer Android APK 工作流
# =========================================================================
name: Buildozer Android APK

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 步骤 1: 检出你的项目代码
    - name: Checkout
      uses: actions/checkout@v4

    # 步骤 2: 设置 Java (JDK)，这是 Android 构建所必需的
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 步骤 3: 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 步骤 4: 安装 Android SDK 和指定版本的构建工具 (核心修改点)
    # 通过 build-tools 参数预先安装好特定版本，并自动接受许可
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        build-tools: "34.0.0" # <--- 预先安装好 build-tools 34.0.0

    # 步骤 5: 安装 Buildozer 及其依赖
    - name: Install Buildozer and dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade buildozer "cython<3.0"

    # 步骤 6: 使用 Buildozer 构建 APK
    - name: Build with Buildozer
      run: |
        buildozer -v android debug

    # 步骤 7: 上传构建好的 APK 文件作为产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-package
        path: bin/*.apk
